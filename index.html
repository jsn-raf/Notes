<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Quick Notes</title>

  <link rel="manifest" href="/Notes/manifest.webmanifest">
  <meta name="theme-color" content="#f5f6f7">
  <meta name="mobile-web-app-capable" content="yes">

  <style>
    body {
      font-family: 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      background: #fff;
      color: #202124;
      overflow: hidden;
    }

    .toolbar {
      background: #f5f6f7;
      padding: 15px;
      display: flex;
      align-items: center;
      border-bottom: 1px solid #e3e5e7;
      height: 50px;
      position: relative;
    }

    .back-arrow {
      font-size: 20px;
      color: #5f6368;
      cursor: pointer;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .title {
      font-weight: 500;
      margin-left: 20px;
      user-select: none;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
    }

    /* ⋮ control */
    .calc-trigger {
      position: absolute;
      right: 6px;
      top: 50%;
      transform: translateY(-50%);
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      color: #5f6368;
      cursor: pointer;
      user-select: none;
      line-height: 1;
      -webkit-tap-highlight-color: transparent;
    }

    .note-area { padding: 20px; }

    .note-body {
      font-size: 18px;
      border: none;
      outline: none;
      width: 100%;
      min-height: calc(100vh - 120px);
      resize: none;
      line-height: 1.6;
      background: transparent;
      color: #202124;
      caret-color: #202124;
      -webkit-overflow-scrolling: touch;
    }

    /* NEW: discreet, high-contrast log near the dots */
    #calcResult {
      position: absolute;
      top: 6px;
      right: 56px;            /* just left of ⋮ */
      font-family: monospace;
      font-size: 14px;        /* larger than before */
      font-weight: 600;
      color: #202124;
      background: #ffffff;
      padding: 4px 6px;
      border-radius: 4px;
      display: none;
      pointer-events: none;  /* can’t be interacted with */
    }
  </style>
</head>

<body>

  <div class="toolbar">
    <span class="back-arrow" id="resetBtn">←</span>
    <span class="title" id="titleBtn">Quick Notes</span>
    <div class="calc-trigger" id="syncBtn" aria-label="More options">⋮</div>

    <!-- moved log -->
    <div id="calcResult">
      <span id="outCard"></span> <span id="outShift"></span>
    </div>
  </div>

  <div class="note-area">
    <textarea id="noteContent" class="note-body" placeholder="Tap to write..."></textarea>
  </div>

  <script>
    const stack = [
      "4C","2H","7D","3C","4H","6D","AS","5H","9S","2S","QH","3D",
      "QC","8H","6S","5S","9H","KC","2D","JH","3S","8S","6H","10C",
      "5D","KD","2C","3H","8D","5C","KS","JD","8C","10S","KH","JC",
      "7S","10H","AD","4S","7H","4D","AC","9C","JS","QD","7C","QS",
      "10D","6C","AH","9D"
    ];

    let lastOutCard = null;
    let lastOutShift = null;

    function hideControl(){ syncBtn.style.display = "none"; }
    function showControl(){ syncBtn.style.display = ""; }
    function isControlHidden(){ return syncBtn.style.display === "none"; }

    function hideLog(){
      calcResult.style.display = "none";
    }

    function showLog(){
      if (!lastOutCard || lastOutShift == null) return;
      outCard.innerText = lastOutCard;
      outShift.innerText = lastOutShift;
      calcResult.style.display = "block";
    }

    function restoreAll(){
      hideLog();
      showControl();
      lastOutCard = null;
      lastOutShift = null;
    }

    function parseFirstInt(s){
      const m = String(s ?? "").match(/-?\d+/);
      return m ? parseInt(m[0], 10) : NaN;
    }

    function require1to52(n){
      if (!Number.isFinite(n)) return NaN;
      if (n < 1 || n > 52) return NaN;
      return n;
    }

    function normaliseCard(input){
      if (!input) return null;
      const raw = input.toUpperCase().trim();
      const compact = raw.replace(/\s+/g,"");
      if (/^(10|[2-9AJQK])[CDHS]$/.test(compact)) return compact;
      const sym = compact.replaceAll("♠","S").replaceAll("♥","H").replaceAll("♦","D").replaceAll("♣","C");
      if (/^(10|[2-9AJQK])[CDHS]$/.test(sym)) return sym;

      const text = raw.replace(/[^A-Z0-9 ]/g," ").replace(/\s+/g," ").trim();
      const tokens = text.split(" ").filter(t=>t && t!=="OF" && t!=="THE");
      const rankMap = {"ACE":"A","KING":"K","QUEEN":"Q","JACK":"J","TEN":"10","NINE":"9","EIGHT":"8","SEVEN":"7","SIX":"6","FIVE":"5","FOUR":"4","THREE":"3","TWO":"2","A":"A","K":"K","Q":"Q","J":"J"};
      const suitMap = {"SPADES":"S","HEARTS":"H","DIAMONDS":"D","CLUBS":"C","S":"S","H":"H","D":"D","C":"C"};

      let r=null,s=null;
      for (const t of tokens){
        if (!r && (rankMap[t] || /^(10|[2-9])$/.test(t))) r = rankMap[t] || t;
        if (!s && suitMap[t]) s = suitMap[t];
      }
      return (r && s) ? r+s : null;
    }

    function positionAfterCut(originalPos, bottomPos){
      const z = (originalPos - bottomPos - 1) % 52;
      return (z < 0 ? z + 52 : z) + 1;
    }

    function revealMathCore(){
      const lines = noteContent.value.split("\n").map(l=>l.trim()).filter(Boolean);
      if (lines.length < 2) return;

      const namedCard = normaliseCard(lines[0]);
      const pos = require1to52(parseFirstInt(lines[1]));
      if (!namedCard || isNaN(pos)) return;

      let bottomCard = null;
      if (lines.length >= 3){
        bottomCard = normaliseCard(lines[2]);
        if (!bottomCard) return;
      }

      let currentPos;
      if (bottomCard){
        const bp = stack.indexOf(bottomCard)+1;
        const op = stack.indexOf(namedCard)+1;
        if (bp<=0 || op<=0) return;
        currentPos = positionAfterCut(op,bp);
        noteContent.value = lines.slice(0,2).join("\n") + "\n";
      } else {
        currentPos = stack.indexOf(namedCard)+1;
        if (currentPos<=0) return;
      }

      const diff = currentPos - pos;
      hideControl();          // hide ⋮ on success

      if (diff === 0){
        lastOutCard = "OK";
        lastOutShift = "0";
        return;
      }

      let shift = diff % 52; if (shift<0) shift+=52;
      lastOutCard = stack[shift-1];
      lastOutShift = String(shift);
    }

    function revealMath(){
      setTimeout(revealMathCore, 200);
    }

    syncBtn.addEventListener("click", revealMath);
    resetBtn.addEventListener("click", () => {
      noteContent.value = "";
      restoreAll();
    });

    /* Long-press title = peek while held */
    let holdTimer=null;
    const HOLD_MS=650;

    function holdStart(e){
      if (e && e.preventDefault) e.preventDefault();
      if (holdTimer) clearTimeout(holdTimer);
      holdTimer = setTimeout(() => {
        if (isControlHidden()) showLog();
      }, HOLD_MS);
    }

    function holdEnd(){
      if (holdTimer){ clearTimeout(holdTimer); holdTimer=null; }
      hideLog();
    }

    titleBtn.addEventListener("mousedown", holdStart);
    titleBtn.addEventListener("touchstart", holdStart, {passive:false});
    titleBtn.addEventListener("mouseup", holdEnd);
    titleBtn.addEventListener("mouseleave", holdEnd);
    titleBtn.addEventListener("touchend", holdEnd);
    titleBtn.addEventListener("touchcancel", holdEnd);

    if ("serviceWorker" in navigator){
      navigator.serviceWorker.register("/Notes/sw.js");
    }
  </script>
</body>
</html>
