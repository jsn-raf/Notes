<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Quick Notes</title>

  <link rel="manifest" href="/Notes/manifest.webmanifest">
  <meta name="theme-color" content="#f5f6f7">
  <meta name="mobile-web-app-capable" content="yes">

  <style>
    body{
      font-family:'Segoe UI', Roboto, sans-serif;
      margin:0;
      background:#fff;
      color:#202124;
      overflow:hidden;
      -webkit-tap-highlight-color:transparent;
    }

    .toolbar{
      background:#f5f6f7;
      padding:15px;
      display:flex;
      align-items:center;
      border-bottom:1px solid #e3e5e7;
      height:50px;
      position:relative;
      touch-action:manipulation;
      user-select:none;
      -webkit-user-select:none;
      -webkit-touch-callout:none;
    }

    /* 1) Stronger anti-selection: everything in the toolbar & about card */
    .toolbar *{
      user-select:none !important;
      -webkit-user-select:none !important;
      -webkit-touch-callout:none !important;
    }

    .back-arrow{
      font-size:20px;
      color:#5f6368;
      cursor:pointer;
      position:relative;
      z-index:3;
      padding:8px 10px;
      margin:-8px -10px;
    }

    .title{
      font-weight:500;
      margin-left:20px;
      pointer-events:none;
    }

    /* Dots: indicator + About button */
    .calc-trigger{
      position:absolute;
      right:6px;
      top:50%;
      transform:translateY(-50%);
      width:44px;
      height:44px;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:auto;
      cursor:pointer;
    }

    .dots{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:3px;
    }

    .vdot{
      width:4px;
      height:4px;
      border-radius:50%;
      background:#5f6368;
      opacity:0.65;
    }

    .calc-trigger.armed-top .vdot.top{ background:#202124; opacity:1; }
    .calc-trigger.armed-mid .vdot.mid{ background:#202124; opacity:1; }
    .calc-trigger.armed-bottom .vdot.bottom{ background:#202124; opacity:1; }

    /* Peek near arrow */
    .peek-arrow{
      position:absolute;
      left:24px;
      top:50%;
      transform:translateY(-50%);
      display:none;
      pointer-events:none;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size:12px;
      font-weight:700;
      line-height:1;
      letter-spacing:0.02em;
      color:#202124;
      text-align:center;
      z-index:2;
      user-select:none;
      -webkit-user-select:none;
      -webkit-touch-callout:none;
    }
    .peek-arrow .card{ display:block; margin-bottom:9px; }
    .peek-arrow .shift{ display:block; margin-top:9px; }

    .note-area{ padding:20px; }

    .note-body{
      font-size:18px;
      border:none;
      outline:none;
      width:100%;
      min-height:calc(100vh - 120px);
      resize:none;
      line-height:1.6;
      background:transparent;
      color:#202124;
      caret-color:#202124;
      -webkit-overflow-scrolling:touch;
    }

    /* 2) Modal-open pointer-event hardening (underlay disabled) */
    body.modal-open .toolbar,
    body.modal-open .note-area{
      pointer-events:none;
    }

    /* About overlay: boring, flat, narrow, light dim */
    .about-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.06);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
      pointer-events:auto;
    }

    .about-card{
      width:calc(100% - 72px);
      max-width:420px;
      background:#fff;
      border-radius:10px;
      padding:16px 16px 14px;
      /* 3) Flatter card: softer shadow */
      box-shadow:0 6px 18px rgba(0,0,0,0.10);
      text-align:left;
    }
    .about-card, .about-card *{
      user-select:none !important;
      -webkit-user-select:none !important;
      -webkit-touch-callout:none !important;
    }

    .about-title{
      /* 3) Slightly flatter hierarchy */
      font-size:14.5px;
      font-weight:500;
      margin:0 0 10px 0;
      color:#202124;
    }

    .about-body{
      font-size:13.5px;
      line-height:1.45;
      color:#202124;
    }

    .about-body p{ margin:0 0 10px 0; }

    .about-footer{
      margin-top:10px;
      font-size:12px;
      line-height:1.35;
      color:#6b7077;
    }
  </style>
</head>

<body>
  <div class="toolbar" id="toolbarBtn">
    <span class="back-arrow" id="resetBtn">←</span>

    <div class="peek-arrow" id="peekArrow">
      <span class="card" id="peekCard"></span>
      <span class="shift" id="peekShift"></span>
    </div>

    <span class="title">Quick Notes</span>

    <div class="calc-trigger" id="aboutBtn" aria-label="More options">
      <div class="dots">
        <span class="vdot top"></span>
        <span class="vdot mid"></span>
        <span class="vdot bottom"></span>
      </div>
    </div>
  </div>

  <div class="note-area">
    <textarea id="noteContent" class="note-body" placeholder="Start typing…"></textarea>
  </div>

  <!-- About popup -->
  <div class="about-overlay" id="aboutOverlay" aria-hidden="true">
    <div class="about-card">
      <div class="about-title">Quick Notes</div>
      <div class="about-body">
        <p>
          A lightweight note-taking utility for quick capture; clean layout focused on speed and clarity.<br>
          All content is stored locally on your device; accessible at any time without setup or accounts.<br>
          Nothing is shared or synced externally.
        </p>
        <p>
          Notes are intentionally minimal by design; optimised for fast access with low distraction.<br>
          Text formatting is kept simple and predictable; everything behaves consistently across sessions.<br>
          Straightforward and unobtrusive.
        </p>
        <div class="about-footer">
          Build 1.3-g4l4h4d · Jan 2026<br>
          © Jason Parry
        </div>
      </div>
    </div>
  </div>

  <script>
    "use strict";

    const toolbarBtn   = document.getElementById("toolbarBtn");
    const resetBtn     = document.getElementById("resetBtn");
    const aboutBtn     = document.getElementById("aboutBtn");
    const aboutOverlay = document.getElementById("aboutOverlay");

    const noteContent  = document.getElementById("noteContent");
    const peekArrow    = document.getElementById("peekArrow");
    const peekCard     = document.getElementById("peekCard");
    const peekShift    = document.getElementById("peekShift");

    toolbarBtn.addEventListener("contextmenu", e => e.preventDefault());

    const stack = [
      "4C","2H","7D","3C","4H","6D","AS","5H","9S","2S","QH","3D",
      "QC","8H","6S","5S","9H","KC","2D","JH","3S","8S","6H","10C",
      "5D","KD","2C","3H","8D","5C","KS","JD","8C","10S","KH","JC",
      "7S","10H","AD","4S","7H","4D","AC","9C","JS","QD","7C","QS",
      "10D","6C","AH","9D"
    ];

    let lastOutCard = null;
    let lastOutShift = null;
    let lastComputedSnapshot = null;
    let isDirty = true;

    function clearArmed(){
      aboutBtn.classList.remove("armed-top","armed-mid","armed-bottom");
    }
    function setArmedMode(mode){
      clearArmed();
      if (mode === "mid") aboutBtn.classList.add("armed-mid");
      else if (mode === "bottom") aboutBtn.classList.add("armed-bottom");
      else aboutBtn.classList.add("armed-top");
    }

    function showPeek(){
      if (!lastOutCard) return;
      peekCard.textContent = lastOutCard;
      peekShift.textContent = lastOutShift;
      peekArrow.style.display = "block";
    }
    function hidePeek(){
      peekArrow.style.display = "none";
      peekCard.textContent = "";
      peekShift.textContent = "";
    }

    noteContent.addEventListener("input", () => {
      isDirty = true;
      lastOutCard = null;
      lastOutShift = null;
      clearArmed();
      hidePeek();
    });

    const suitMap = {
      SPADES:"S",SPADE:"S",S:"S","♠":"S",
      HEARTS:"H",HEART:"H",H:"H","♥":"H",
      DIAMONDS:"D",DIAMOND:"D",D:"D","♦":"D",
      CLUBS:"C",CLUB:"C",C:"C","♣":"C"
    };
    const rankMap = {
      ACE:"A",A:"A",KING:"K",K:"K",QUEEN:"Q",Q:"Q",JACK:"J",J:"J",
      TEN:"10","10":"10",NINE:"9","9":"9",EIGHT:"8","8":"8",
      SEVEN:"7","7":"7",SIX:"6","6":"6",FIVE:"5","5":"5",
      FOUR:"4","4":"4",THREE:"3","3":"3",TWO:"2","2":"2"
    };

    function findCardInText(text){
      if (!text) return null;
      const raw = String(text);

      const compactRe = /(10|[2-9AJQK])\s*([CDHS♠♥♦♣])/ig;
      let m;
      while ((m = compactRe.exec(raw)) !== null) {
        const r = String(m[1]).toUpperCase();
        const s = ({"♠":"S","♥":"H","♦":"D","♣":"C"}[m[2]] || String(m[2]).toUpperCase());
        const code = r + s;
        if (/^(10|[2-9AJQK])[CDHS]$/.test(code)) return { code, start: m.index, end: m.index + m[0].length };
      }

      const tokenRe = /[A-Za-z0-9♠♥♦♣]+/g;
      let t, suitTok=null, rankTok=null;
      while ((t = tokenRe.exec(raw)) !== null) {
        const u = t[0].toUpperCase(), s=t.index, e=s+t[0].length;
        if (!suitTok && suitMap[u]) suitTok={u,s,e};
        if (!rankTok && rankMap[u]) rankTok={u,s,e};
        if (suitTok && rankTok) break;
      }
      if (!suitTok || !rankTok) return null;
      return { code: rankMap[rankTok.u] + suitMap[suitTok.u], start: Math.min(suitTok.s, rankTok.s), end: Math.max(suitTok.e, rankTok.e) };
    }

    function normaliseCard(line){
      const f = findCardInText(String(line ?? ""));
      return f ? f.code : null;
    }

    function normaliseNumberTextKeepLength(s){
      return String(s ?? "")
        .replace(/\u00A0/g, " ")
        .replace(/[\u2010-\u2014]/g, "-");
    }

    const ones = {
      ONE:1,TWO:2,THREE:3,FOUR:4,FIVE:5,SIX:6,SEVEN:7,EIGHT:8,NINE:9,
      TEN:10,ELEVEN:11,TWELVE:12,THIRTEEN:13,FOURTEEN:14,FIFTEEN:15,
      SIXTEEN:16,SEVENTEEN:17,EIGHTEEN:18,NINETEEN:19
    };
    const tens = { TWENTY:20, THIRTY:30, FORTY:40, FIFTY:50 };

    function findPositionInLine(line){
      const s = normaliseNumberTextKeepLength(String(line ?? ""));
      if (!s.trim()) return null;

      const d = /\d+/.exec(s);
      if (d) {
        const v = parseInt(d[0], 10);
        if (v >= 1 && v <= 52) return { value: v, start: d.index, end: d.index + d[0].length };
      }

      const re = /\b(one|two|three|four|five|six|seven|eight|nine|ten|eleven|twelve|thirteen|fourteen|fifteen|sixteen|seventeen|eighteen|nineteen|twenty|thirty|forty|fifty)(?:[-\s]+(one|two|three|four|five|six|seven|eight|nine|ten|eleven|twelve|thirteen|fourteen|fifteen|sixteen|seventeen|eighteen|nineteen))?\b/ig;
      let best=null,m;
      while ((m = re.exec(s)) !== null) {
        const a = String(m[1]).toUpperCase(), b = m[2] ? String(m[2]).toUpperCase() : null;
        let v = NaN;
        if (ones[a] != null) v = ones[a];
        else if (tens[a] != null && b && ones[b] != null) v = tens[a] + ones[b];
        else if (tens[a] != null && !b) v = tens[a];

        if (Number.isFinite(v) && v >= 1 && v <= 52) {
          const cand = { value: v, start: m.index, end: m.index + m[0].length };
          if (!best || (cand.end - cand.start) > (best.end - best.start)) best = cand;
        }
      }
      return best;
    }

    function removeSpanPolished(orig, start, end){
      let before = orig.slice(0, start).replace(/\b(of|the)\b[\s\-]*$/i, "");
      let after  = orig.slice(end).replace(/^[\s\-]*\b(of|the)\b/i, "");
      return (before + after).replace(/\s{2,}/g, " ").replace(/[ \t]+$/g, "");
    }

    function buildDeckNow(bottomCard){
      if (!bottomCard) return stack.slice();
      const bi = stack.indexOf(bottomCard);
      if (bi < 0) return null;
      return stack.slice(bi + 1).concat(stack.slice(0, bi + 1));
    }

    function compute(){
      if (!isDirty && lastComputedSnapshot === noteContent.value) return;

      const raw = noteContent.value.split("\n");
      const line1 = raw[0] ?? "";
      const line2 = raw[1] ?? "";
      const line3 = raw[2] ?? "";

      if (!line1.trim() || !line2.trim()) return;

      const namedCard = normaliseCard(line1);
      if (!namedCard) return;

      const posInfo = findPositionInLine(line2);
      if (!posInfo) return;

      let bottomCard = null;
      let mode = "top";
      let inlineSpan = null;

      if (line3.trim()) {
        const b3 = normaliseCard(line3);
        if (!b3) return;
        bottomCard = b3;
        mode = "bottom";
      } else {
        const remainder = line2.slice(posInfo.end);
        const found = findCardInText(remainder);
        if (found) {
          bottomCard = found.code;
          mode = "mid";
          inlineSpan = { s: posInfo.end + found.start, e: posInfo.end + found.end };
        }
      }

      const deckNow = buildDeckNow(bottomCard);
      if (!deckNow) return;

      const namedIdxNow = deckNow.indexOf(namedCard);
      if (namedIdxNow < 0) return;

      const currentPos = namedIdxNow + 1;
      const diff = currentPos - posInfo.value;

      if (diff === 0) {
        lastOutCard = "00";
        lastOutShift = "0";
      } else {
        let shift = diff % 52;
        if (shift < 0) shift += 52;
        lastOutCard = deckNow[shift - 1];
        lastOutShift = String(shift);
      }

      if (mode === "bottom") {
        noteContent.value = line1 + "\n" + line2;
      } else if (mode === "mid" && inlineSpan) {
        noteContent.value = line1 + "\n" + removeSpanPolished(line2, inlineSpan.s, inlineSpan.e);
      }

      setArmedMode(mode);
      lastComputedSnapshot = noteContent.value;
      isDirty = false;
    }

    /* Toolbar gesture handling */
    const HOLD_MS = 650;
    const MOVE_TOL = 10;

    let holdTimer = null;
    let peekShownThisGesture = false;
    let startX = 0, startY = 0;
    let startedOnReset = false;
    let startedOnAbout = false;

    function aboutIsOpen(){
      return aboutOverlay.style.display === "flex";
    }

    function clearHold(){
      if (holdTimer) { clearTimeout(holdTimer); holdTimer = null; }
    }

    function isInReset(target){
      return !!(target && target.closest && target.closest("#resetBtn"));
    }

    function isInAbout(target){
      return !!(target && target.closest && target.closest("#aboutBtn"));
    }

    function onDown(e){
      if (aboutIsOpen()) return;

      startedOnReset = isInReset(e.target);
      startedOnAbout = isInAbout(e.target);
      if (startedOnAbout) return;
      if (startedOnReset) return;

      if (document.activeElement === noteContent) noteContent.blur();

      peekShownThisGesture = false;
      startX = e.clientX;
      startY = e.clientY;

      try { toolbarBtn.setPointerCapture(e.pointerId); } catch (_) {}

      clearHold();
      holdTimer = setTimeout(() => {
        peekShownThisGesture = true;
        showPeek();
      }, HOLD_MS);
    }

    function onMove(e){
      if (aboutIsOpen()) return;
      if (startedOnReset || startedOnAbout || !holdTimer) return;

      if (Math.abs(e.clientX - startX) > MOVE_TOL || Math.abs(e.clientY - startY) > MOVE_TOL) {
        clearHold();
        hidePeek();
      }
    }

    function onUpOrCancel(){
      if (aboutIsOpen()) return;

      if (startedOnReset) { startedOnReset = false; return; }
      if (startedOnAbout) { startedOnAbout = false; return; }

      clearHold();

      if (peekShownThisGesture) {
        hidePeek();
        clearArmed();
        return;
      }

      hidePeek();
      setTimeout(compute, 50);
    }

    toolbarBtn.addEventListener("pointerdown", onDown);
    toolbarBtn.addEventListener("pointermove", onMove);
    toolbarBtn.addEventListener("pointerup", onUpOrCancel);
    toolbarBtn.addEventListener("pointercancel", onUpOrCancel);

    resetBtn.addEventListener("click", () => {
      if (aboutIsOpen()) return;
      clearHold();
      startedOnReset = false;
      startedOnAbout = false;
      peekShownThisGesture = false;

      noteContent.blur();
      noteContent.value = "";

      lastOutCard = null;
      lastOutShift = null;
      clearArmed();
      hidePeek();

      lastComputedSnapshot = null;
      isDirty = true;
    });

    /* About popup – open/close with modal hardening */
    function openAbout(){
      hidePeek();
      noteContent.blur();
      document.body.classList.add("modal-open");
      aboutOverlay.style.display = "flex";
      aboutOverlay.setAttribute("aria-hidden", "false");
    }
    function closeAbout(){
      aboutOverlay.style.display = "none";
      aboutOverlay.setAttribute("aria-hidden", "true");
      document.body.classList.remove("modal-open");
    }

    // Ensure dots never trigger toolbar compute/peek.
    ["pointerdown","pointerup","click"].forEach(evt => {
      aboutBtn.addEventListener(evt, (e) => {
        e.preventDefault();
        e.stopPropagation();
      });
    });

    aboutBtn.addEventListener("click", () => {
      if (aboutIsOpen()) closeAbout();
      else openAbout();
    });

    aboutOverlay.addEventListener("click", (e) => {
      if (e.target === aboutOverlay) closeAbout();
    });

    /* Service worker */
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/Notes/sw.js").catch(() => {});
    }
  </script>
</body>
</html>
