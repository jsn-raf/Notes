<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Quick Notes</title>

  <link rel="manifest" href="/Notes/manifest.webmanifest">
  <meta name="theme-color" content="#f5f6f7">
  <meta name="mobile-web-app-capable" content="yes">

  <style>
    body {
      font-family: 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      background: #fff;
      color: #202124;
      overflow: hidden;
    }

    .toolbar {
      background: #f5f6f7;
      padding: 15px;
      display: flex;
      align-items: center;
      border-bottom: 1px solid #e3e5e7;
      height: 50px;
      position: relative;
    }

    .back-arrow {
      font-size: 20px;
      color: #5f6368;
      cursor: pointer;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      position: relative;
      z-index: 2;
    }

    .title {
      font-weight: 500;
      margin-left: 20px;
      user-select: none;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
    }

    /* Dots control */
    .calc-trigger {
      position: absolute;
      right: 6px;
      top: 50%;
      transform: translateY(-50%);
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .dots {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 3px;
    }

    .vdot {
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: #5f6368;
      opacity: 0.65;
    }

    /* Armed indicator: top dot */
    .calc-trigger.armed-top .vdot.top {
      background: #202124;
      opacity: 1;
    }

    /* Armed indicator: bottom dot */
    .calc-trigger.armed-bottom .vdot.bottom {
      background: #202124;
      opacity: 1;
    }

    /* Peek anchored near arrow (nudged right) */
    .peek-arrow {
      position: absolute;
      left: 24px;
      top: 50%;
      transform: translateY(-50%);
      display: none;
      pointer-events: none;
      user-select: none;
      -webkit-user-select: none;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 12px;
      font-weight: 700;
      line-height: 1;
      letter-spacing: 0.02em;
      color: #202124;
      text-align: center;
    }

    .peek-arrow .card {
      display: block;
      margin-bottom: 9px;
    }

    .peek-arrow .shift {
      display: block;
      margin-top: 9px;
    }

    .note-area { padding: 20px; }

    .note-body {
      font-size: 18px;
      border: none;
      outline: none;
      width: 100%;
      min-height: calc(100vh - 120px);
      resize: none;
      line-height: 1.6;
      background: transparent;
      color: #202124;
      caret-color: #202124;
      -webkit-overflow-scrolling: touch;
    }
  </style>
</head>

<body>
  <div class="toolbar">
    <span class="back-arrow" id="resetBtn">‚Üê</span>

    <!-- Peek above / below arrow -->
    <div class="peek-arrow" id="peekArrow">
      <span class="card" id="peekCard"></span>
      <span class="shift" id="peekShift"></span>
    </div>

    <span class="title" id="titleBtn">Quick Notes</span>

    <div class="calc-trigger" id="syncBtn" aria-label="More options">
      <div class="dots">
        <span class="vdot top"></span>
        <span class="vdot mid"></span>
        <span class="vdot bottom"></span>
      </div>
    </div>
  </div>

  <div class="note-area">
    <textarea id="noteContent" class="note-body" placeholder="Tap to write..."></textarea>
  </div>

  <script>
    const stack = [
      "4C","2H","7D","3C","4H","6D","AS","5H","9S","2S","QH","3D",
      "QC","8H","6S","5S","9H","KC","2D","JH","3S","8S","6H","10C",
      "5D","KD","2C","3H","8D","5C","KS","JD","8C","10S","KH","JC",
      "7S","10H","AD","4S","7H","4D","AC","9C","JS","QD","7C","QS",
      "10D","6C","AH","9D"
    ];

    let lastOutCard = null;
    let lastOutShift = null;

    function clearArmed() {
      syncBtn.classList.remove("armed-top");
      syncBtn.classList.remove("armed-bottom");
    }

    function setArmed(which) {
      clearArmed();
      if (which === "bottom") syncBtn.classList.add("armed-bottom");
      else syncBtn.classList.add("armed-top"); // default
    }

    function showPeekArrow() {
      if (!lastOutCard || lastOutShift == null) return;
      peekCard.textContent = lastOutCard;
      peekShift.textContent = lastOutShift;
      peekArrow.style.display = "block";
    }

    function hidePeekArrow() {
      peekArrow.style.display = "none";
      peekCard.textContent = "";
      peekShift.textContent = "";
    }

    function parseFirstInt(s) {
      const m = String(s ?? "").match(/-?\d+/);
      return m ? parseInt(m[0], 10) : NaN;
    }

    function require1to52(n) {
      return Number.isFinite(n) && n >= 1 && n <= 52 ? n : NaN;
    }

    function normaliseCard(input) {
      if (!input) return null;
      const raw = input.toUpperCase().trim().replace(/\s+/g, "");
      if (/^(10|[2-9AJQK])[CDHS]$/.test(raw)) return raw;
      return null;
    }

    function positionAfterCut(op, bp) {
      const z = (op - bp - 1) % 52;
      return (z < 0 ? z + 52 : z) + 1;
    }

    function compute() {
      const lines = noteContent.value.split("\n").map(l => l.trim()).filter(Boolean);
      if (lines.length < 2) return;

      const card = normaliseCard(lines[0]);
      const pos = require1to52(parseFirstInt(lines[1]));
      if (!card || isNaN(pos)) return;

      // Detect whether we actually used a valid third line
      let usedThirdLine = false;

      let cur;
      if (lines[2]) {
        const bottom = normaliseCard(lines[2]);
        if (!bottom) return;                 // invalid third line => do nothing
        usedThirdLine = true;

        cur = positionAfterCut(stack.indexOf(card)+1, stack.indexOf(bottom)+1);
        noteContent.value = lines.slice(0,2).join("\n") + "\n";
      } else {
        cur = stack.indexOf(card)+1;
      }

      const diff = cur - pos;
      if (diff === 0) {
        lastOutCard = "00";
        lastOutShift = "0";
      } else {
        let s = diff % 52;
        if (s < 0) s += 52;
        lastOutCard = stack[s-1];
        lastOutShift = String(s);
      }

      // Arm top dot normally, bottom dot when third line was used
      setArmed(usedThirdLine ? "bottom" : "top");
    }

    syncBtn.addEventListener("click", () => setTimeout(compute, 180));

    resetBtn.addEventListener("click", () => {
      noteContent.value = "";
      lastOutCard = null;
      lastOutShift = null;
      clearArmed();
      hidePeekArrow();
    });

    let holdTimer = null;
    const HOLD_MS = 650;

    function holdStart(e) {
      if (e && e.preventDefault) e.preventDefault();
      holdTimer = setTimeout(showPeekArrow, HOLD_MS);
    }

    function holdEnd() {
      clearTimeout(holdTimer);
      hidePeekArrow();
      clearArmed();
    }

    titleBtn.addEventListener("mousedown", holdStart);
    titleBtn.addEventListener("touchstart", holdStart, { passive:false });
    titleBtn.addEventListener("mouseup", holdEnd);
    titleBtn.addEventListener("mouseleave", holdEnd);
    titleBtn.addEventListener("touchend", holdEnd);
    titleBtn.addEventListener("touchcancel", holdEnd);
  </script>
</body>
</html>
