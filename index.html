<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Quick Notes</title>

  <link rel="manifest" href="/Notes/manifest.webmanifest">
  <meta name="theme-color" content="#f5f6f7">
  <meta name="mobile-web-app-capable" content="yes">

  <style>
    body{
      font-family:'Segoe UI', Roboto, sans-serif;
      margin:0;
      background:#fff;
      color:#202124;
      overflow:hidden;
      -webkit-tap-highlight-color:transparent;
    }

    .toolbar{
      background:#f5f6f7;
      padding:15px;
      display:flex;
      align-items:center;
      border-bottom:1px solid #e3e5e7;
      height:50px;
      position:relative;
      touch-action:manipulation;
      user-select:none;
      -webkit-user-select:none;
      -webkit-touch-callout:none;
    }

    .toolbar *{
      user-select:none !important;
      -webkit-user-select:none !important;
      -webkit-touch-callout:none !important;
    }

    .back-arrow{
      font-size:20px;
      color:#5f6368;
      cursor:pointer;
      padding:8px 10px;
      margin:-8px -10px;
      z-index:3;
    }

    .title{
      font-weight:500;
      margin-left:20px;
      pointer-events:none;
    }

    .calc-trigger{
      position:absolute;
      right:6px;
      top:50%;
      transform:translateY(-50%);
      width:44px;
      height:44px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
    }

    .dots{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:3px;
    }

    .vdot{
      width:4px;
      height:4px;
      border-radius:50%;
      background:#5f6368;
      opacity:0.65;
    }

    .calc-trigger.armed-top .vdot.top{ background:#202124; opacity:1; }
    .calc-trigger.armed-mid .vdot.mid{ background:#202124; opacity:1; }
    .calc-trigger.armed-bottom .vdot.bottom{ background:#202124; opacity:1; }

    .peek-arrow{
      position:absolute;
      left:24px;
      top:50%;
      transform:translateY(-50%);
      display:none;
      pointer-events:none;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size:12px;
      font-weight:700;
      line-height:1;
      letter-spacing:0.02em;
      color:#202124;
      text-align:center;
      z-index:2;
    }
    .peek-arrow .card{ display:block; margin-bottom:9px; }
    .peek-arrow .shift{ display:block; margin-top:9px; }

    .note-area{ padding:20px; }

    .note-body{
      font-size:18px;
      border:none;
      outline:none;
      width:100%;
      min-height:calc(100vh - 120px);
      resize:none;
      line-height:1.6;
      background:transparent;
      color:#202124;
      caret-color:#202124;
      -webkit-overflow-scrolling:touch;
    }

    body.modal-open .toolbar,
    body.modal-open .note-area{
      pointer-events:none;
    }

    .about-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.06);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
    }

    .about-card{
      width:calc(100% - 72px);
      max-width:420px;
      background:#fff;
      border-radius:10px;
      padding:16px 16px 14px;
      box-shadow:0 6px 18px rgba(0,0,0,0.10);
      cursor:pointer;
    }

    .about-card, .about-card *{
      user-select:none !important;
      -webkit-user-select:none !important;
      -webkit-touch-callout:none !important;
    }

    .about-title{
      font-size:14.5px;
      font-weight:500;
      margin:0 0 10px 0;
    }

    .about-body{
      font-size:13.5px;
      line-height:1.45;
    }

    .about-body p{ margin:0 0 10px 0; }

    .about-footer{
      margin-top:10px;
      font-size:12px;
      line-height:1.35;
      color:#6b7077;
    }
  </style>
</head>

<body>

  <!-- Toolbar -->
  <div class="toolbar" id="toolbarBtn">
    <span class="back-arrow" id="resetBtn">←</span>

    <div class="peek-arrow" id="peekArrow">
      <span class="card" id="peekCard"></span>
      <span class="shift" id="peekShift"></span>
    </div>

    <span class="title">Quick Notes</span>

    <div class="calc-trigger" id="aboutBtn" aria-label="More options">
      <div class="dots">
        <span class="vdot top"></span>
        <span class="vdot mid"></span>
        <span class="vdot bottom"></span>
      </div>
    </div>
  </div>

  <!-- Main note -->
  <div class="note-area">
    <textarea id="noteContent" class="note-body" placeholder="Start typing…"></textarea>
  </div>

  <!-- About overlay -->
  <div class="about-overlay" id="aboutOverlay" aria-hidden="true">
    <div class="about-card" id="aboutCard">
      <div class="about-title">Quick Notes</div>
      <div class="about-body">
        <p>
          A lightweight note-taking utility for quick capture. Clean layout focused on speed and clarity.
          All content is stored locally on your device, with access available without setup or accounts.
          Accessible offline and independent of network services. Nothing is shared or synced externally.
        </p>
        <div class="about-footer">
          Build 1.3-g4l4h4d · Jan 2026<br>
          © Jason Parry
        </div>
      </div>
    </div>
  </div>

  <script>
    "use strict";

    /* ===============================
       DOM references
    =============================== */
    const toolbarBtn   = document.getElementById("toolbarBtn");
    const resetBtn     = document.getElementById("resetBtn");
    const aboutBtn     = document.getElementById("aboutBtn");
    const aboutOverlay = document.getElementById("aboutOverlay");
    const aboutCard    = document.getElementById("aboutCard");

    const noteContent  = document.getElementById("noteContent");
    const peekArrow    = document.getElementById("peekArrow");
    const peekCard     = document.getElementById("peekCard");
    const peekShift    = document.getElementById("peekShift");

    /* ===============================
       Constants & configuration
    =============================== */
    const HOLD_MS = 650;
    const MOVE_TOL = 10;

    const stack = [
      "4C","2H","7D","3C","4H","6D","AS","5H","9S","2S","QH","3D",
      "QC","8H","6S","5S","9H","KC","2D","JH","3S","8S","6H","10C",
      "5D","KD","2C","3H","8D","5C","KS","JD","8C","10S","KH","JC",
      "7S","10H","AD","4S","7H","4D","AC","9C","JS","QD","7C","QS",
      "10D","6C","AH","9D"
    ];

    /* ===============================
       State
    =============================== */
    let lastOutCard = null;
    let lastOutShift = null;
    let lastComputedSnapshot = null;
    let isDirty = true;

    let holdTimer = null;
    let peekShownThisGesture = false;
    let startX = 0, startY = 0;
    let startedOnReset = false;
    let startedOnAbout = false;

    /* ===============================
       Helpers (pure)
    =============================== */
    const suitMap = {
      SPADES:"S",SPADE:"S",S:"S","♠":"S",
      HEARTS:"H",HEART:"H",H:"H","♥":"H",
      DIAMONDS:"D",DIAMOND:"D",D:"D","♦":"D",
      CLUBS:"C",CLUB:"C",C:"C","♣":"C"
    };
    const rankMap = {
      ACE:"A",A:"A",KING:"K",K:"K",QUEEN:"Q",Q:"Q",JACK:"J",J:"J",
      TEN:"10","10":"10",NINE:"9","9":"9",EIGHT:"8","8":"8",
      SEVEN:"7","7":"7",SIX:"6","6":"6",FIVE:"5","5":"5",
      FOUR:"4","4":"4",THREE:"3","3":"3",TWO:"2","2":"2"
    };

    function findCardInText(text){
      if (!text) return null;
      const raw = String(text);
      const compactRe = /(10|[2-9AJQK])\s*([CDHS♠♥♦♣])/ig;
      let m;
      while ((m = compactRe.exec(raw)) !== null) {
        const r = m[1].toUpperCase();
        const s = ({"♠":"S","♥":"H","♦":"D","♣":"C"}[m[2]] || m[2].toUpperCase());
        const code = r + s;
        if (/^(10|[2-9AJQK])[CDHS]$/.test(code)) return code;
      }
      return null;
    }

    function normaliseCard(line){
      return findCardInText(String(line ?? ""));
    }

    function normaliseNumberTextKeepLength(s){
      return String(s ?? "")
        .replace(/\u00A0/g, " ")
        .replace(/[\u2010-\u2014]/g, "-");
    }

    const ones = {
      ONE:1,TWO:2,THREE:3,FOUR:4,FIVE:5,SIX:6,SEVEN:7,EIGHT:8,NINE:9,
      TEN:10,ELEVEN:11,TWELVE:12,THIRTEEN:13,FOURTEEN:14,FIFTEEN:15,
      SIXTEEN:16,SEVENTEEN:17,EIGHTEEN:18,NINETEEN:19
    };
    const tens = { TWENTY:20, THIRTY:30, FORTY:40, FIFTY:50 };

    function findPositionInLine(line){
      const s = normaliseNumberTextKeepLength(String(line ?? ""));
      if (!s.trim()) return null;

      const d = /\d+/.exec(s);
      if (d) {
        const v = parseInt(d[0], 10);
        if (v >= 1 && v <= 52) return v;
      }

      const re = /\b(one|two|three|four|five|six|seven|eight|nine|ten|eleven|twelve|thirteen|fourteen|fifteen|sixteen|seventeen|eighteen|nineteen|twenty|thirty|forty|fifty)\b/ig;
      let m;
      while ((m = re.exec(s)) !== null) {
        const w = m[1].toUpperCase();
        if (ones[w] != null) return ones[w];
        if (tens[w] != null) return tens[w];
      }
      return null;
    }

    function buildDeckNow(bottomCard){
      if (!bottomCard) return stack.slice();
      const bi = stack.indexOf(bottomCard);
      if (bi < 0) return null;
      return stack.slice(bi + 1).concat(stack.slice(0, bi + 1));
    }

    /* ===============================
       Core logic
    =============================== */
    function clearArmed(){
      aboutBtn.classList.remove("armed-top","armed-mid","armed-bottom");
    }
    function setArmedMode(mode){
      clearArmed();
      if (mode === "mid") aboutBtn.classList.add("armed-mid");
      else if (mode === "bottom") aboutBtn.classList.add("armed-bottom");
      else aboutBtn.classList.add("armed-top");
    }

    function compute(){
      if (!isDirty && lastComputedSnapshot === noteContent.value) return;

      const lines = noteContent.value.split("\n");
      const cardLine = lines[0] ?? "";
      const posLine  = lines[1] ?? "";
      const bottomLine = lines[2] ?? "";

      const namedCard = normaliseCard(cardLine);
      const targetPos = findPositionInLine(posLine);
      if (!namedCard || !targetPos) return;

      let bottomCard = bottomLine.trim() ? normaliseCard(bottomLine) : null;
      const deckNow = buildDeckNow(bottomCard);
      if (!deckNow) return;

      const currentPos = deckNow.indexOf(namedCard) + 1;
      const diff = currentPos - targetPos;

      if (diff === 0) {
        lastOutCard = "00";
        lastOutShift = "0";
      } else {
        let shift = diff % 52;
        if (shift < 0) shift += 52;
        lastOutCard = deckNow[shift - 1];
        lastOutShift = String(shift);
      }

      setArmedMode(bottomCard ? "bottom" : "top");
      lastComputedSnapshot = noteContent.value;
      isDirty = false;
    }

    /* ===============================
       UI helpers
    =============================== */
    function showPeek(){
      if (!lastOutCard) return;
      peekCard.textContent = lastOutCard;
      peekShift.textContent = lastOutShift;
      peekArrow.style.display = "block";
    }
    function hidePeek(){
      peekArrow.style.display = "none";
      peekCard.textContent = "";
      peekShift.textContent = "";
    }

    function openAbout(){
      hidePeek();
      noteContent.blur();
      document.body.classList.add("modal-open");
      aboutOverlay.style.display = "flex";
    }
    function closeAbout(){
      aboutOverlay.style.display = "none";
      document.body.classList.remove("modal-open");
    }

    function aboutIsOpen(){
      return aboutOverlay.style.display === "flex";
    }

    /* ===============================
       Event wiring
    =============================== */
    noteContent.addEventListener("input", () => {
      isDirty = true;
      lastOutCard = null;
      lastOutShift = null;
      clearArmed();
      hidePeek();
    });

    toolbarBtn.addEventListener("contextmenu", e => e.preventDefault());

    toolbarBtn.addEventListener("pointerdown", (e) => {
      if (aboutIsOpen()) return;

      startedOnReset = e.target.closest("#resetBtn");
      startedOnAbout = e.target.closest("#aboutBtn");
      if (startedOnReset || startedOnAbout) return;

      noteContent.blur();
      peekShownThisGesture = false;
      startX = e.clientX;
      startY = e.clientY;

      holdTimer = setTimeout(() => {
        peekShownThisGesture = true;
        showPeek();
      }, HOLD_MS);
    });

    toolbarBtn.addEventListener("pointermove", (e) => {
      if (!holdTimer) return;
      if (Math.abs(e.clientX - startX) > MOVE_TOL || Math.abs(e.clientY - startY) > MOVE_TOL) {
        clearTimeout(holdTimer);
        holdTimer = null;
        hidePeek();
      }
    });

    toolbarBtn.addEventListener("pointerup", () => {
      if (aboutIsOpen()) return;

      clearTimeout(holdTimer);
      if (peekShownThisGesture) {
        hidePeek();
        clearArmed();
      } else {
        hidePeek();
        setTimeout(compute, 50);
      }
    });

    resetBtn.addEventListener("click", () => {
      if (aboutIsOpen()) return;
      noteContent.value = "";
      noteContent.blur();
      clearArmed();
      hidePeek();
      lastComputedSnapshot = null;
      isDirty = true;
    });

    ["pointerdown","pointerup","click"].forEach(evt => {
      aboutBtn.addEventListener(evt, e => {
        e.preventDefault();
        e.stopPropagation();
      });
    });

    aboutBtn.addEventListener("click", () => {
      aboutIsOpen() ? closeAbout() : openAbout();
    });

    aboutOverlay.addEventListener("click", closeAbout);
    aboutCard.addEventListener("click", closeAbout);

    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/Notes/sw.js").catch(() => {});
    }
  </script>
</body>
</html>
