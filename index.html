<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Quick Notes</title>

  <link rel="manifest" href="/Notes/manifest.webmanifest">
  <meta name="theme-color" content="#f5f6f7">
  <meta name="mobile-web-app-capable" content="yes">

  <style>
    body{
      font-family:'Segoe UI', Roboto, sans-serif;
      margin:0;
      background:#fff;
      color:#202124;
      overflow:hidden;
    }
    .toolbar{
      background:#f5f6f7;
      padding:15px;
      display:flex;
      align-items:center;
      border-bottom:1px solid #e3e5e7;
      height:50px;
      position:relative;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
    }
    .back-arrow{
      font-size:20px;
      color:#5f6368;
      cursor:pointer;
      position:relative;
      z-index:3;
      padding:8px 10px;
      margin:-8px -10px;
    }
    .title{
      font-weight:500;
      margin-left:20px;
      pointer-events:none;
    }
    .calc-trigger{
      position:absolute;
      right:6px;
      top:50%;
      transform:translateY(-50%);
      width:44px;
      height:44px;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
    }
    .dots{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:3px;
    }
    .vdot{
      width:4px;
      height:4px;
      border-radius:50%;
      background:#5f6368;
      opacity:0.65;
    }
    .calc-trigger.armed-top .vdot.top{ background:#202124; opacity:1; }
    .calc-trigger.armed-mid .vdot.mid{ background:#202124; opacity:1; }
    .calc-trigger.armed-bottom .vdot.bottom{ background:#202124; opacity:1; }

    .peek-arrow{
      position:absolute;
      left:24px;
      top:50%;
      transform:translateY(-50%);
      display:none;
      pointer-events:none;
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size:12px;
      font-weight:700;
      line-height:1;
      letter-spacing:0.02em;
      color:#202124;
      text-align:center;
      z-index:2;
    }
    .peek-arrow .card{ display:block; margin-bottom:9px; }
    .peek-arrow .shift{ display:block; margin-top:9px; }

    .note-area{ padding:20px; }
    .note-body{
      font-size:18px;
      border:none;
      outline:none;
      width:100%;
      min-height:calc(100vh - 120px);
      resize:none;
      line-height:1.6;
      background:transparent;
      color:#202124;
      caret-color:#202124;
      -webkit-overflow-scrolling:touch;
    }
  </style>
</head>

<body>
  <div class="toolbar" id="toolbarBtn">
    <span class="back-arrow" id="resetBtn">←</span>

    <div class="peek-arrow" id="peekArrow">
      <span class="card" id="peekCard"></span>
      <span class="shift" id="peekShift"></span>
    </div>

    <span class="title">Quick Notes</span>

    <div class="calc-trigger" id="syncBtn" aria-hidden="true">
      <div class="dots">
        <span class="vdot top"></span>
        <span class="vdot mid"></span>
        <span class="vdot bottom"></span>
      </div>
    </div>
  </div>

  <div class="note-area">
    <textarea id="noteContent" class="note-body" placeholder="Start typing…"></textarea>
  </div>

  <script>
    "use strict";

    const stack = [
      "4C","2H","7D","3C","4H","6D","AS","5H","9S","2S","QH","3D",
      "QC","8H","6S","5S","9H","KC","2D","JH","3S","8S","6H","10C",
      "5D","KD","2C","3H","8D","5C","KS","JD","8C","10S","KH","JC",
      "7S","10H","AD","4S","7H","4D","AC","9C","JS","QD","7C","QS",
      "10D","6C","AH","9D"
    ];

    let lastOutCard=null,lastOutShift=null;

    function clearArmed(){ syncBtn.classList.remove("armed-top","armed-mid","armed-bottom"); }
    function setArmedMode(mode){
      clearArmed();
      syncBtn.classList.add(mode==="line3"?"armed-bottom":mode==="line2"?"armed-mid":"armed-top");
    }

    function showPeek(){
      if(!lastOutCard) return;
      peekCard.textContent=lastOutCard;
      peekShift.textContent=lastOutShift;
      peekArrow.style.display="block";
    }
    function hidePeek(){
      peekArrow.style.display="none";
      peekCard.textContent="";
      peekShift.textContent="";
    }

    const suitMap={SPADES:"S",SPADE:"S",S:"S","♠":"S",HEARTS:"H",HEART:"H",H:"H","♥":"H",DIAMONDS:"D",DIAMOND:"D",D:"D","♦":"D",CLUBS:"C",CLUB:"C",C:"C","♣":"C"};
    const rankMap={ACE:"A",A:"A",KING:"K",K:"K",QUEEN:"Q",Q:"Q",JACK:"J",J:"J",TEN:"10","10":"10",NINE:"9","9":"9",EIGHT:"8","8":"8",SEVEN:"7","7":"7",SIX:"6","6":"6",FIVE:"5","5":"5",FOUR:"4","4":"4",THREE:"3","3":"3",TWO:"2","2":"2"};

    function findCardInText(text){
      if(!text) return null;
      const raw=String(text);
      const compactRe=/(10|[2-9AJQK])\s*([CDHS♠♥♦♣])/ig;
      let m;
      while((m=compactRe.exec(raw))!==null){
        const r=m[1].toUpperCase();
        const s={"♠":"S","♥":"H","♦":"D","♣":"C"}[m[2]]||m[2].toUpperCase();
        const code=r+s;
        if(/^(10|[2-9AJQK])[CDHS]$/.test(code)) return {code,start:m.index,end:m.index+m[0].length};
      }
      const tokens=[...raw.matchAll(/[A-Za-z0-9♠♥♦♣]+/g)].map(t=>({v:t[0],u:t[0].toUpperCase(),s:t.index,e:t.index+t[0].length}));
      let suitTok=null,rankTok=null;
      for(const t of tokens){ if(!suitTok&&suitMap[t.u]) suitTok=t; if(!rankTok&&rankMap[t.u]) rankTok=t; }
      if(!suitTok||!rankTok) return null;
      const code=rankMap[rankTok.u]+suitMap[suitTok.u];
      if(!/^(10|[2-9AJQK])[CDHS]$/.test(code)) return null;
      return {code,start:Math.min(suitTok.s,rankTok.s),end:Math.max(suitTok.e,rankTok.e)};
    }

    const ones={ONE:1,TWO:2,THREE:3,FOUR:4,FIVE:5,SIX:6,SEVEN:7,EIGHT:8,NINE:9,TEN:10,ELEVEN:11,TWELVE:12,THIRTEEN:13,FOURTEEN:14,FIFTEEN:15,SIXTEEN:16,SEVENTEEN:17,EIGHTEEN:18,NINETEEN:19};
    const tens={TWENTY:20,THIRTY:30,FORTY:40,FIFTY:50};

    function findPositionInLine(line){
      const s=String(line);
      const d=/\d+/.exec(s);
      if(d){ const v=parseInt(d[0],10); if(v>=1&&v<=52) return {value:v,start:d.index,end:d.index+d[0].length}; }
      const re=/\b(one|two|three|four|five|six|seven|eight|nine|ten|eleven|twelve|thirteen|fourteen|fifteen|sixteen|seventeen|eighteen|nineteen|twenty|thirty|forty|fifty)(?:[-\s]+(one|two|three|four|five|six|seven|eight|nine|ten|eleven|twelve|thirteen|fourteen|fifteen|sixteen|seventeen|eighteen|nineteen))?\b/ig;
      let best=null,m;
      while((m=re.exec(s))!==null){
        const a=m[1].toUpperCase(),b=m[2]?.toUpperCase();
        let v=ones[a]??(tens[a]?(b? tenses:undefined):undefined);
        if(tens[a]) v=b&&ones[b]?tens[a]+ones[b]:tens[a];
        if(Number.isFinite(v)&&v>=1&&v<=52){
          const cand={value:v,start:m.index,end:m.index+m[0].length};
          if(!best||cand.end-cand.start>best.end-best.start) best=cand;
        }
      }
      return best;
    }

    function removeSpanPreserveSpacing(orig,start,end){
      let out=orig.slice(0,start)+orig.slice(end);
      out=out.replace(/\s{2,}/g," ").replace(/[ \t]+$/,"");
      return out;
    }

    function positionAfterCut(op,bp){
      const z=(op-bp-1)%52;
      return (z<0?z+52:z)+1;
    }

    function compute(){
      const lines=noteContent.value.split("\n").map(l=>l.trim()).filter(Boolean);
      if(lines.length<2) return;

      const named=findCardInText(lines[0]);
      if(!named) return;
      const posInfo=findPositionInLine(lines[1]);
      if(!posInfo) return;

      let cut=null,mode="top",span=null;
      if(lines[2]){
        const c=findCardInText(lines[2]); if(!c) return;
        cut=c.code; mode="bottom";
      }else{
        const rem=lines[1].slice(posInfo.end);
        const c=findCardInText(rem);
        if(c){ cut=c.code; mode="mid"; span={s:posInfo.end+c.start,e:posInfo.end+c.end}; }
      }

      const op=stack.indexOf(named.code)+1;
      if(op<1) return;
      const cur=cut?positionAfterCut(op,stack.indexOf(cut)+1):op;
      const diff=cur-posInfo.value;
      if(diff===0){ lastOutCard="00"; lastOutShift="0"; }
      else{ let s=diff%52; if(s<0)s+=52; lastOutCard=stack[s-1]; lastOutShift=String(s); }

      if(mode==="bottom") noteContent.value=[lines[0],lines[1]].join("\n")+"\n";
      if(mode==="mid"&&span) noteContent.value=[lines[0],removeSpanPreserveSpacing(lines[1],span.s,span.e)].join("\n")+"\n";

      setArmedMode(mode);
    }

    const toolbarBtn=document.getElementById("toolbarBtn");
    const resetBtn=document.getElementById("resetBtn");
    let holdTimer=null,isHolding=false,startX=0,startY=0;
    const HOLD_MS=650,MOVE_TOL=10;

    function clearHold(){ if(holdTimer){clearTimeout(holdTimer);holdTimer=null;} isHolding=false; }

    function onDown(e){
      startX=e.clientX; startY=e.clientY;
      clearHold();
      holdTimer=setTimeout(()=>{isHolding=true;showPeek();},HOLD_MS);
    }
    function onMove(e){
      if(!holdTimer) return;
      if(Math.abs(e.clientX-startX)>MOVE_TOL||Math.abs(e.clientY-startY)>MOVE_TOL){
        clearHold(); hidePeek();
      }
    }
    function onUp(){
      const wasHolding=isHolding;
      clearHold();
      if(wasHolding){ hidePeek(); clearArmed(); return; }
      hidePeek(); setTimeout(compute,80);
    }

    resetBtn.addEventListener("pointerdown",e=>e.stopPropagation());
    resetBtn.addEventListener("pointerup",e=>e.stopPropagation());
    resetBtn.addEventListener("click",e=>e.stopPropagation());
    resetBtn.addEventListener("click",()=>{
      clearHold(); noteContent.value=""; lastOutCard=null; lastOutShift=null; clearArmed(); hidePeek();
    });

    toolbarBtn.addEventListener("pointerdown",onDown);
    toolbarBtn.addEventListener("pointermove",onMove);
    toolbarBtn.addEventListener("pointerup",onUp);
    toolbarBtn.addEventListener("pointercancel",onUp);

    if("serviceWorker" in navigator){
      navigator.serviceWorker.register("/Notes/sw.js").catch(()=>{});
    }
  </script>
</body>
</html>
