<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Quick Notes</title>

  <link rel="manifest" href="/Notes/manifest.webmanifest">
  <meta name="theme-color" content="#f5f6f7">
  <meta name="mobile-web-app-capable" content="yes">

  <style>
    body{
      font-family:'Segoe UI', Roboto, sans-serif;
      margin:0;
      background:#fff;
      color:#202124;
      overflow:hidden;
      -webkit-tap-highlight-color:transparent;
    }

    .toolbar{
      background:#f5f6f7;
      padding:15px;
      display:flex;
      align-items:center;
      border-bottom:1px solid #e3e5e7;
      height:50px;
      position:relative;
      touch-action:manipulation;
      user-select:none;
      -webkit-user-select:none;
      -webkit-touch-callout:none;
    }
    .toolbar *{
      user-select:none !important;
      -webkit-user-select:none !important;
      -webkit-touch-callout:none !important;
    }

    .back-arrow{
      font-size:20px;
      color:#5f6368;
      cursor:pointer;
      padding:8px 10px;
      margin:-8px -10px;
      z-index:3;
    }

    .title{
      font-weight:500;
      margin-left:20px;
      pointer-events:none;
    }

    .calc-trigger{
      position:absolute;
      right:6px;
      top:50%;
      transform:translateY(-50%);
      width:44px;
      height:44px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
    }

    .dots{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:3px;
    }

    .vdot{
      width:4px;
      height:4px;
      border-radius:50%;
      background:#5f6368;
      opacity:0.65;
    }

    .calc-trigger.armed-top .vdot.top{ background:#202124; opacity:1; }
    .calc-trigger.armed-mid .vdot.mid{ background:#202124; opacity:1; }
    .calc-trigger.armed-bottom .vdot.bottom{ background:#202124; opacity:1; }

    .peek-arrow{
      position:absolute;
      left:28px;
      top:50%;
      transform:translateY(-50%);
      display:none;
      pointer-events:none;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size:12px;
      font-weight:700;
      letter-spacing:0.02em;
      color:#202124;
      z-index:2;
      text-align:right;
      min-width:3ch;
    }
    .peek-arrow .card{ display:block; }
    .peek-arrow .shift{ display:block; margin-top:9px; }

    .note-area{ padding:20px; }
    .note-body{
      font-size:18px;
      border:none;
      outline:none;
      width:100%;
      min-height:calc(100vh - 120px);
      resize:none;
      line-height:1.6;
      background:transparent;
      color:#202124;
      caret-color:#202124;
      -webkit-overflow-scrolling:touch;
    }

    body.modal-open .toolbar,
    body.modal-open .note-area{
      pointer-events:none;
    }

    .about-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.06);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
    }

    .about-card{
      width:calc(100% - 72px);
      max-width:420px;
      background:#fff;
      border-radius:10px;
      padding:16px 16px 14px;
      box-shadow:0 6px 18px rgba(0,0,0,0.10);
      cursor:pointer;
    }

    .about-card,
    .about-card *{
      user-select:none !important;
      -webkit-user-select:none !important;
      -webkit-touch-callout:none !important;
      -webkit-tap-highlight-color:transparent !important;
    }

    .about-title{
      font-size:14.5px;
      font-weight:500;
      margin:0 0 10px 0;
    }

    .about-body{
      font-size:13.5px;
      line-height:1.45;
    }

    .about-footer{
      margin-top:10px;
      font-size:12px;
      line-height:1.35;
      color:#6b7077;
    }
  </style>
</head>

<body>

  <div class="toolbar" id="toolbarBtn">
    <span class="back-arrow" id="resetBtn">←</span>

    <div class="peek-arrow" id="peekArrow">
      <span class="card" id="peekCard"></span>
      <span class="shift" id="peekShift"></span>
    </div>

    <span class="title">Quick Notes</span>

    <div class="calc-trigger" id="aboutBtn">
      <div class="dots">
        <span class="vdot top"></span>
        <span class="vdot mid"></span>
        <span class="vdot bottom"></span>
      </div>
    </div>
  </div>

  <div class="note-area">
    <textarea id="noteContent" class="note-body" placeholder="Start typing…"></textarea>
  </div>

  <div class="about-overlay" id="aboutOverlay">
    <div class="about-card" id="aboutCard">
      <div class="about-title">Quick Notes</div>
      <div class="about-body">
        <p>
          A simple note-taking utility. Clean layout with predictable behaviour.
          All content is stored locally on your device. Accessible without accounts.
          No additional features are included.
        </p>
        <div class="about-footer">
          Build 1.3-g4l4h4d · Jan 2026<br>
          © Jason Parry
        </div>
      </div>
    </div>
  </div>

  <script>
    "use strict";

    const toolbarBtn = document.getElementById("toolbarBtn");
    const resetBtn = document.getElementById("resetBtn");
    const aboutBtn = document.getElementById("aboutBtn");
    const aboutOverlay = document.getElementById("aboutOverlay");
    const aboutCard = document.getElementById("aboutCard");

    const noteContent = document.getElementById("noteContent");
    const peekArrow = document.getElementById("peekArrow");
    const peekCard = document.getElementById("peekCard");
    const peekShift = document.getElementById("peekShift");

    const HOLD_MS = 650;
    const MOVE_TOL = 10;

    const stack = [
      "4C","2H","7D","3C","4H","6D","AS","5H","9S","2S","QH","3D",
      "QC","8H","6S","5S","9H","KC","2D","JH","3S","8S","6H","10C",
      "5D","KD","2C","3H","8D","5C","KS","JD","8C","10S","KH","JC",
      "7S","10H","AD","4S","7H","4D","AC","9C","JS","QD","7C","QS",
      "10D","6C","AH","9D"
    ];

    let lastOutCard = null;
    let lastOutShift = null;
    let lastSnapshot = null;
    let isDirty = true;

    let holdTimer = null;
    let peeked = false;
    let startX = 0, startY = 0;
    let activePointerId = null;

    const suitWord = { SPADES:"S",HEARTS:"H",DIAMONDS:"D",CLUBS:"C",SPADE:"S",HEART:"H",DIAMOND:"D",CLUB:"C" };
    const rankWord = { ACE:"A",KING:"K",QUEEN:"Q",JACK:"J",TEN:"10",NINE:"9",EIGHT:"8",SEVEN:"7",SIX:"6",FIVE:"5",FOUR:"4",THREE:"3",TWO:"2" };
    const suitSym  = { "♠":"S","♥":"H","♦":"D","♣":"C" };

    function clearDots(){
      aboutBtn.classList.remove("armed-top","armed-mid","armed-bottom");
    }

    function findCardSpan(text){
      if(!text) return null;
      const compact=/(10|[2-9AJQK])\s*([CDHS♠♥♦♣])/ig;
      let m;
      while((m=compact.exec(text))){
        const r=m[1].toUpperCase();
        const s=suitSym[m[2]]||m[2].toUpperCase();
        const code=r+s;
        if(/^(10|[2-9AJQK])[CDHS]$/.test(code))
          return{code,start:m.index,end:m.index+m[0].length};
      }
      const tokenRe=/[A-Za-z0-9♠♥♦♣]+/g;
      let rank=null,suit=null,rs=null,ss=null,t;
      while((t=tokenRe.exec(text))){
        const u=t[0].toUpperCase();
        if(!rank&&(rankWord[u]||/^(10|[2-9])$/.test(u)||/^[AJQK]$/.test(u))){
          rank=rankWord[u]||u;rs={s:t.index,e:t.index+t[0].length};
        }
        if(!suit&&(suitWord[u]||suitSym[t[0]])){
          suit=suitWord[u]||suitSym[t[0]];ss={s:t.index,e:t.index+t[0].length};
        }
        if(rank&&suit)break;
      }
      if(!rank||!suit)return null;
      const code=rank+suit;
      if(!/^(10|[2-9AJQK])[CDHS]$/.test(code))return null;
      return{code,start:Math.min(rs.s,ss.s),end:Math.max(rs.e,ss.e)};
    }

    function findPositionSpan(line){
      const d=/\d+/.exec(line);
      if(d){
        const v=parseInt(d[0],10);
        if(v>=1&&v<=52)return{v,start:d.index,end:d.index+d[0].length};
      }
      return null;
    }

    function buildDeck(bottom){
      if(!bottom)return stack.slice();
      const i=stack.indexOf(bottom);
      if(i<0)return null;
      return stack.slice(i+1).concat(stack.slice(0,i+1));
    }

    function removeSpan(s,a,b){
      return(s.slice(0,a)+s.slice(b)).replace(/\s{2,}/g," ").trimEnd();
    }

    function compute(){
      if(!isDirty&&lastSnapshot===noteContent.value)return;
      const lines=noteContent.value.split("\n");
      if(lines.length<2)return;
      const card=findCardSpan(lines[0]);
      const pos=findPositionSpan(lines[1]);
      if(!card||!pos)return;

      let bottom=null,mode="top",span=null;
      if(lines[2]){
        const b=findCardSpan(lines[2]);
        if(!b)return;
        bottom=b.code;mode="bottom";
      }else{
        const rest=lines[1].slice(pos.end);
        const b=findCardSpan(rest);
        if(b){bottom=b.code;mode="mid";span={s:pos.end+b.start,e:pos.end+b.end};}
      }

      const deck=buildDeck(bottom);
      if(!deck)return;
      const cur=deck.indexOf(card.code)+1;
      if(cur<=0)return;

      const diff=cur-pos.v;
      if(diff===0){lastOutCard="00";lastOutShift="0";}
      else{
        let sh=diff%52;if(sh<0)sh+=52;
        lastOutCard=deck[sh-1];lastOutShift=""+sh;
      }

      if(mode==="bottom")noteContent.value=lines[0]+"\n"+lines[1];
      if(mode==="mid"&&span)noteContent.value=lines[0]+"\n"+removeSpan(lines[1],span.s,span.e);

      clearDots();
      aboutBtn.classList.add("armed-"+mode);
      lastSnapshot=noteContent.value;
      isDirty=false;
    }

    function showPeek(){
      if(!noteContent.value.trim()||!lastOutCard)return;
      peekCard.textContent=lastOutCard;
      peekShift.textContent=lastOutShift;
      peekArrow.style.display="block";
    }

    function hidePeek(){
      peekArrow.style.display="none";
      peekCard.textContent="";
      peekShift.textContent="";
    }

    function clearHoldAndPeek(pointerId){
      if(holdTimer){clearTimeout(holdTimer);holdTimer=null;}
      hidePeek();
      if(peeked){
        clearDots();
        peeked=false;
      }
      if(pointerId!=null){
        try{toolbarBtn.releasePointerCapture(pointerId);}catch(_){}
      }
      if(pointerId===activePointerId)activePointerId=null;
    }

    function openAbout(){
      hidePeek();
      document.body.classList.add("modal-open");
      aboutOverlay.style.display="flex";
      noteContent.blur();
      if(document.activeElement)document.activeElement.blur();
    }

    function closeAbout(){
      aboutOverlay.style.display="none";
      document.body.classList.remove("modal-open");
    }

    noteContent.addEventListener("input",()=>{
      isDirty=true;
      lastOutCard=null;
      lastOutShift=null;
      hidePeek();
      clearDots();
    });

    ["pointerdown","pointerup","click"].forEach(ev=>{
      aboutBtn.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();});
    });

    aboutBtn.addEventListener("click",()=>{
      if(aboutOverlay.style.display==="flex")closeAbout();
      else openAbout();
    });

    aboutOverlay.addEventListener("click",closeAbout);
    aboutCard.addEventListener("click",e=>{
      e.stopPropagation();
      closeAbout();
    });

    toolbarBtn.addEventListener("pointerdown",(e)=>{
      if(e.target.closest("#aboutBtn")||e.target.closest("#resetBtn"))return;
      activePointerId=e.pointerId;
      try{toolbarBtn.setPointerCapture(activePointerId);}catch(_){}
      clearHoldAndPeek();
      peeked=false;
      startX=e.clientX;startY=e.clientY;
      holdTimer=setTimeout(()=>{peeked=true;showPeek();},HOLD_MS);
    });

    toolbarBtn.addEventListener("pointermove",(e)=>{
      if(!holdTimer)return;
      if(Math.abs(e.clientX-startX)>MOVE_TOL||Math.abs(e.clientY-startY)>MOVE_TOL){
        clearHoldAndPeek(activePointerId);
      }
    });

    toolbarBtn.addEventListener("pointerup",(e)=>{
      const wasPeeked=peeked;
      clearHoldAndPeek(e.pointerId);
      if(!wasPeeked)compute();
    });

    toolbarBtn.addEventListener("pointercancel",(e)=>{clearHoldAndPeek(e.pointerId);});
    toolbarBtn.addEventListener("lostpointercapture",(e)=>{clearHoldAndPeek(e.pointerId);});
    document.addEventListener("visibilitychange",()=>{if(document.hidden)clearHoldAndPeek(activePointerId);});
    window.addEventListener("pagehide",()=>{clearHoldAndPeek(activePointerId);});

    resetBtn.addEventListener("click",()=>{
      noteContent.value="";
      hidePeek();
      lastOutCard=null;
      lastOutShift=null;
      clearDots();
      isDirty=true;
      lastSnapshot=null;
      requestAnimationFrame(()=>{
        noteContent.blur();
        noteContent.scrollTop=0;
        noteContent.scrollLeft=0;
        if(noteContent.setSelectionRange)noteContent.setSelectionRange(0,0);
      });
    });

    if("serviceWorker"in navigator){
      navigator.serviceWorker.register("/Notes/sw.js").catch(()=>{});
    }
  </script>
</body>
</html>
